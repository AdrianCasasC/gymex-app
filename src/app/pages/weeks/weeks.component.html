<section class="week-top">
  <h1>Semanas</h1>
  <div (click)="showWeekModal = true" class="add_week centered primary-box">
    <span>{{ "week.add" | transloco }}</span>
    <mat-icon>add_circle_outline</mat-icon>
  </div>
</section>

<div class="weeks-content flex-col-cent">
  <p-progressSpinner
    *ngIf="spinnerService.spinnerState$ | async"
    styleClass="w-4rem h-4rem"
    strokeWidth="2"
    animationDuration="1s"
  ></p-progressSpinner>

  <section
    *ngIf="
      myWeeks.length > 0 && (spinnerService.spinnerState$ | async) === false;
      else noWeeks
    "
    class="weeks-container"
  >
    <ng-container *ngFor="let week of myWeeks">
      <span
        (click)="selectWeek(week)"
        (longPress)="onLongPress(week)"
        [ngClass]="{ 'selected-box': selectedWeek?.id === week.id }"
        class="primary-box week"
        >{{ week.name }}
      </span>
      <app-properties-popup
        *ngIf="week.showProperties"
        [position]="'top'"
        (clickOutsideContent)="week.showProperties = false"
        (selectedOption)="popupSelectedOption($event, week)"
      ></app-properties-popup>
    </ng-container>
  </section>

  <ng-container *ngFor="let week of myWeeks">
    <section
      *ngIf="selectedWeek?.id === week.id"
      class="week-days-container centered"
    >
      <span
        *ngFor="let day of week.days"
        (click)="selectWeekDay(day)"
        class="primary-box week-day"
        [ngClass]="{ 'selected-box': areEqualObjects(selectedDay, day) }"
      >
        {{ "daysOfWeek." + day.name | transloco }}
      </span>
    </section>
  </ng-container>

  <section *ngIf="selectedDay" class="routine-day-wrapper">
    <div *ngIf="!selectedDay?.routine; else routine" class="no-routine">
      <span
        >No hay ninguna rutina asociada al
        {{ "daysOfWeek." + selectedDay.name | transloco }}</span
      >
      <button (click)="openRoutinesModal()" class="secondary-box">
        Añadir rutina
      </button>
    </div>

    <ng-template #routine>
      <h2 class="routine-title centered">
        {{ "daysOfWeek." + selectedDay.name | transloco }} de
        {{ selectedDay.routine?.name }}
      </h2>

      <section>
        <div
          *ngFor="let exercise of selectedDay.routine?.exercises; let i = index"
        >
          <h3>{{ "exercises." + exercise.name | transloco }}</h3>
          <div
            *ngFor="let serie of exercise.series; let j = index"
            class="series-wrapper primary-box"
            [style.margin-bottom]="serie.showLastWeek ? '110px' : '12px'"
          >
            <div
              class="series"
              (click)="
                copySerie(serie);
                saveExerciseAndSerieIndex(i, j);
                openModal();
                selectedExercise = exercise
              "
            >
              <strong>Serie {{ j + 1 }}:</strong> X
              {{ serie.reps ? serie.reps : "___" }} X
              {{ serie.weight ? serie.weight : "___" }} Kgs

              <div
                *ngIf="serie.showLastWeek"
                class="primary-box last-week"
                [style.justify-content]="
                  !existSomeLastWeekRegister(
                    exercise.series[j].lastWeekCoincidences
                  ) && 'center'
                "
                [style.transform]="
                  serie.showLastWeek ? 'translateY(0)' : 'translateY(-20px)'
                "
              >
                <ng-container
                  *ngIf="
                    existSomeLastWeekRegister(
                      exercise.series[j].lastWeekCoincidences
                    );
                    else noLastWeekRegister
                  "
                >
                  <div
                    *ngFor="
                      let coincidence of exercise.series[j].lastWeekCoincidences
                    "
                    class="flex-col-cent last-week__serie"
                  >
                    <ng-container
                      *ngIf="coincidence.reps !== 0 && coincidence.weight !== 0"
                    >
                      <strong
                        >Semana pasada -
                        {{
                          "daysOfWeek." + coincidence.weekDay | transloco
                        }}</strong
                      >
                      <span
                        ><strong>Serie {{ j + 1 }}:</strong>
                        X
                        {{ coincidence.reps }}
                        X
                        {{ coincidence.weight }}
                        Kgs
                      </span>
                    </ng-container>
                  </div>
                </ng-container>

                <ng-template #noLastWeekRegister>
                  <strong [style.width]="'100%'"
                    >No se tienen registos de la semana pasada</strong
                  >
                </ng-template>
              </div>
            </div>
            <mat-icon (click)="serie.showLastWeek = !serie.showLastWeek">{{
              serie.showLastWeek ? "arrow_circle_down" : "arrow_circle_up"
            }}</mat-icon>
          </div>
        </div>
      </section>
    </ng-template>
  </section>

  <section class="desassociate" *ngIf="selectedDay?.routine">
    <button (click)="onDesassociateRoutine()" class="primary-box">
      {{ "week.desassociate" | transloco }}
    </button>
  </section>
</div>

<app-input-modal
  *ngIf="showWeekModal"
  (closeModal)="showWeekModal = false"
  (writtenText)="addNewWeek($event)"
  [labelText]="'week.modal-label' | transloco"
  class="modal"
></app-input-modal>

<app-input-modal
  *ngIf="showChangeWeekNameModal"
  (closeModal)="showChangeWeekNameModal = false"
  (writtenText)="changeWeekName($event)"
  [labelText]="'Nuevo nombre de la semana'"
  class="modal"
></app-input-modal>

<div *ngIf="showRoutinesModal" class="modal">
  <div
    (clickOutside)="closeAssociateRoutineModal()"
    class="flex-col content primary-box modal-content"
  >
    <div
      *ngIf="savedRoutines.length > 0; else noRoutines"
      class="flex-col-cent"
    >
      <i (click)="closeAssociateRoutineModal()" class="centered close-cross"
        >X</i
      >
      <h2>Selecciona rutina a añadir</h2>
      <span *ngIf="selectedAssociatedRoutine"
        >Rutina seleccionada: {{ selectedAssociatedRoutine.name }}</span
      >
      <span *ngIf="!isRoutineSelected">¡Debes Seleccionar una rutina!</span>
      <section class="routines-wrapper">
        <span
          [ngClass]="{
            selectedRoutine:
              selectedAssociatedRoutine &&
              selectedAssociatedRoutine!.name === routine.name
          }"
          *ngFor="let routine of savedRoutines"
          (click)="
            selectedAssociatedRoutine = routine; isRoutineSelected = true
          "
          >{{ routine.name }}</span
        >
      </section>

      <button
        (click)="onAssociateRoutine(selectedAssociatedRoutine)"
        class="secondary-box"
      >
        {{ "week.associateRoutine" | transloco }}
      </button>
    </div>

    <ng-template #noRoutines>
      <span>{{ "week.noRoutine" | transloco }}</span>
      <button (click)="goToRoutines()" class="secondary-box">
        {{ "week.goToRoutine" | transloco }}
      </button>
    </ng-template>
  </div>
</div>

<div *ngIf="showSerieModal" class="modal">
  <div class="modal-content primary-box">
    <i (click)="closeModal()" class="close-cross">X</i>
    <section>
      <h2>{{ "exercises." + selectedExercise.name | transloco }}</h2>
      <h3>Serie {{ editedSerieIndex + 1 }}</h3>
    </section>

    <section class="input-field">
      <label for="reps">Repeticiones</label>
      <input
        type="number"
        min="0"
        id="reps"
        name="reps"
        [(ngModel)]="selectedSerie.reps"
      />
    </section>

    <section class="input-field">
      <label for="weight">Peso</label>
      <input
        type="number"
        min="0"
        id="weight"
        name="weight"
        [(ngModel)]="selectedSerie.weight"
      />
    </section>

    <section class="modal-buttons-container">
      <button (click)="applyChanges()" class="modal-buttons secondary-box">
        {{ "button.accept" | transloco }}
      </button>
      <button (click)="closeModal()" class="modal-buttons secondary-box">
        {{ "button.cancel" | transloco }}
      </button>
    </section>
  </div>
</div>

<ng-template #noWeeks>
  <section
    class="noWeeks flex-col-cent"
    *ngIf="(spinnerService.spinnerState$ | async) === false"
  >
    <h2>{{ "week.noWeeks" | transloco }}</h2>
    <img [src]="exerciseImagesLinks.noWeeks" />
  </section>
</ng-template>
